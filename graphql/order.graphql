type Order {
    id: ID!
    value: String!
    company_id: ID!
    project_id: ID!
    order_number: String!
    delivery_date: Date
    actual_delivery_date: Date
    is_active: Boolean!
    is_urgent: Boolean!
    "Сумма закупки"
    order_amount: Float
    "Процент агента (дефолт 5%)"
    agent_percentage: Float!
    "Процент куратора (дефолт 5%)"
    curator_percentage: Float!
    "Рассчитанный бонус агента (order_amount × agent_percentage / 100)"
    agent_bonus: Float
    "Рассчитанный бонус куратора (order_amount × curator_percentage / 100)"
    curator_bonus: Float
    "ID статуса оплаты партнёром"
    partner_payment_status_id: ID!
    "Статус оплаты партнёром"
    partnerPaymentStatus: PartnerPaymentStatus @belongsTo
    "Дата оплаты партнёром"
    partner_payment_date: Date
    "ID статуса заказа"
    status_id: ID
    "Статус заказа"
    status: OrderStatus @belongsTo
    "Комментарии к заказу"
    comments: [Comment!] @field(resolver: "App\\GraphQL\\Resolvers\\OrderCommentsResolver")
    created_at: DateTime!
    updated_at: DateTime!
    company: Company! @belongsTo
    project: Project! @belongsTo
    positions: [OrderPosition!]! @hasMany
}

type OrderPosition {
    id: ID!
    order_id: ID!
    value: String!
    article: String!
    price: Float!
    count: Int!
    total_price: Float!
    supplier: String
    expected_delivery_date: Date
    actual_delivery_date: Date
    is_active: Boolean!
    is_urgent: Boolean!
    created_at: DateTime!
    updated_at: DateTime!
    order: Order! @belongsTo
}

input CreateOrderInput {
    value: String!
    company_id: ID!
    project_id: ID!
    order_number: String
    delivery_date: Date
    actual_delivery_date: Date
    is_active: Boolean = true
    is_urgent: Boolean = false
    "Сумма закупки"
    order_amount: Float @rules(apply: ["nullable", "numeric", "min:0"])
    "Процент агента (дефолт 5%)"
    agent_percentage: Float = 5.0 @rules(apply: ["nullable", "numeric", "min:0", "max:100"])
    "Процент куратора (дефолт 5%)"
    curator_percentage: Float = 5.0 @rules(apply: ["nullable", "numeric", "min:0", "max:100"])
    positions: [CreateOrderPositionInput!]!
}

input CreateOrderPositionInput {
    value: String!
    article: String!
    price: Float!
    count: Int!
    supplier: String
    expected_delivery_date: Date
    actual_delivery_date: Date
    is_active: Boolean = true
    is_urgent: Boolean = false
}

input UpdateOrderInput {
    id: ID!
    value: String
    company_id: ID
    project_id: ID
    order_number: String
    delivery_date: Date
    actual_delivery_date: Date
    is_active: Boolean
    is_urgent: Boolean
    "Сумма закупки"
    order_amount: Float @rules(apply: ["nullable", "numeric", "min:0"])
    "Процент агента"
    agent_percentage: Float @rules(apply: ["nullable", "numeric", "min:0", "max:100"])
    "Процент куратора"
    curator_percentage: Float @rules(apply: ["nullable", "numeric", "min:0", "max:100"])
}

input UpdateOrderPositionInput {
    id: ID!
    value: String
    article: String
    price: Float
    count: Int
    supplier: String
    expected_delivery_date: Date
    actual_delivery_date: Date
    is_active: Boolean
    is_urgent: Boolean
}

"Статус заказа"
type OrderStatus {
    id: ID!
    value: String!
    slug: String!
    description: String
    color: String
    icon: String
    sort_order: Int!
    is_default: Boolean!
    is_active: Boolean!
}

extend type Query {
    "Get all orders"
    orders: [Order!]! @paginate

    "Get a single order by ID"
    order(id: ID! @whereKey): Order @find

    "Get orders by company"
    ordersByCompany(company_id: ID! @where): [Order!]! @paginate

    "Get orders by project"
    ordersByProject(project_id: ID! @where): [Order!]! @paginate

    "Get urgent orders"
    urgentOrders(is_urgent: Boolean! @where): [Order!]! @paginate

    "Get active orders"
    activeOrders(is_active: Boolean! @where): [Order!]! @paginate

    "Get all order statuses"
    orderStatuses: [OrderStatus!]! @all(model: "App\\Models\\OrderStatus", scopes: ["active"])
}

input CreateSingleOrderPositionInput {
    order_id: ID!
    value: String!
    article: String!
    price: Float!
    count: Int!
    supplier: String
    expected_delivery_date: Date
    actual_delivery_date: Date
    is_active: Boolean = true
    is_urgent: Boolean = false
}

extend type Mutation {
    "Create a new order with positions"
    createOrder(input: CreateOrderInput!): Order! @field(resolver: "App\\GraphQL\\Mutations\\CreateOrder")

    "Update an existing order"
    updateOrder(input: UpdateOrderInput!): Order!
        @field(resolver: "App\\GraphQL\\Mutations\\UpdateOrder")

    "Delete an order"
    deleteOrder(id: ID! @whereKey): Order! @delete(model: "App\\Models\\Order")

    "Update order status"
    updateOrderStatus(order_id: ID!, status_slug: String!): Order!
        @field(resolver: "App\\GraphQL\\Mutations\\UpdateOrderStatus")

    "Create a new order position"
    createOrderPosition(input: CreateSingleOrderPositionInput! @spread): OrderPosition! @create(model: "App\\Models\\OrderPosition")

    "Update an order position"
    updateOrderPosition(input: UpdateOrderPositionInput! @spread): OrderPosition! @update(model: "App\\Models\\OrderPosition")

    "Delete an order position"
    deleteOrderPosition(id: ID! @whereKey): OrderPosition! @delete(model: "App\\Models\\OrderPosition")

    "Add a comment to an order"
    addOrderComment(order_id: ID!, value: String!, author_name: String): Comment!
        @field(resolver: "App\\GraphQL\\Mutations\\AddOrderComment")

    "Update an order comment"
    updateOrderComment(id: ID!, value: String!): Comment!
        @field(resolver: "App\\GraphQL\\Mutations\\UpdateOrderComment")
}
