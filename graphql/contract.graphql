type Contract {
    id: ID!
    project_id: ID!
    company_id: ID!
    status_id: ID
    partner_payment_status_id: ID
    project: Project @belongsTo
    company: Company @belongsTo
    status: ContractStatus @belongsTo
    partnerPaymentStatus: PartnerPaymentStatus @belongsTo
    contract_number: String
    contract_date: Date!
    planned_completion_date: Date!
    actual_completion_date: Date
    contract_amount: Float
    agent_percentage: Float!
    curator_percentage: Float!
    "Рассчитанный бонус агента (contract_amount × agent_percentage / 100)"
    agent_bonus: Float
    "Рассчитанный бонус куратора (contract_amount × curator_percentage / 100)"
    curator_bonus: Float
    is_active: Boolean!
    created_at: DateTime!
    updated_at: DateTime!
}

input CreateContractInput {
    project_id: ID! @rules(apply: ["required", "exists:projects,id"])
    company_id: ID! @rules(apply: ["required", "exists:companies,id"])
    contract_number: String @rules(apply: ["nullable", "string", "max:255", "unique:contracts,contract_number"])
    contract_date: Date! @rules(apply: ["required", "date"])
    planned_completion_date: Date! @rules(apply: ["required", "date", "after_or_equal:contract_date"])
    actual_completion_date: Date @rules(apply: ["nullable", "date"])
    contract_amount: Float @rules(apply: ["nullable", "numeric", "min:0"])
    agent_percentage: Float! @rules(apply: ["required", "numeric", "min:0", "max:100"])
    curator_percentage: Float! @rules(apply: ["required", "numeric", "min:0", "max:100"])
    is_active: Boolean = true
}

input UpdateContractInput {
    id: ID! @rules(apply: ["required", "exists:contracts,id"])
    project_id: ID @rules(apply: ["sometimes", "exists:projects,id"])
    company_id: ID @rules(apply: ["sometimes", "exists:companies,id"])
    contract_number: String @rules(apply: ["nullable", "string", "max:255"])
    contract_date: Date @rules(apply: ["sometimes", "date"])
    planned_completion_date: Date @rules(apply: ["sometimes", "date"])
    actual_completion_date: Date @rules(apply: ["nullable", "date"])
    contract_amount: Float @rules(apply: ["nullable", "numeric", "min:0"])
    agent_percentage: Float @rules(apply: ["sometimes", "numeric", "min:0", "max:100"])
    curator_percentage: Float @rules(apply: ["sometimes", "numeric", "min:0", "max:100"])
    is_active: Boolean
}

extend type Query {
    "Get all contracts with pagination"
    contracts(first: Int = 1000, page: Int): [Contract!]! @paginate

    "Get a single contract by ID"
    contract(id: ID! @whereKey): Contract @find

    "Get contracts by project"
    contractsByProject(project_id: ID! @where): [Contract!]! @all

    "Get contracts by company"
    contractsByCompany(company_id: ID! @where): [Contract!]! @all

    "Get all contract statuses"
    contractStatuses: [ContractStatus!]! @all(model: "App\\Models\\ContractStatus", scopes: ["active"])
}

extend type Mutation {
    "Create a new contract with automatic bonus creation"
    createContract(input: CreateContractInput!): Contract!
        @field(resolver: "App\\GraphQL\\Mutations\\CreateContract")

    "Update an existing contract with automatic bonus recalculation"
    updateContract(input: UpdateContractInput!): Contract!
        @field(resolver: "App\\GraphQL\\Mutations\\UpdateContract")

    "Delete a contract"
    deleteContract(id: ID! @whereKey): Contract! @delete

    "Update contract status"
    updateContractStatus(contract_id: ID!, status_slug: String!): Contract!
        @field(resolver: "App\\GraphQL\\Mutations\\UpdateContractStatus")
}
