enum ProjectStatus {
    ACTIVE @enum(value: "active")
    COMPLETED @enum(value: "completed")
    CANCELLED @enum(value: "cancelled")
}

enum AgentRateType {
    PERCENTAGE @enum(value: "percentage")
    FIXED @enum(value: "fixed")
}

type ProjectStatusType {
    id: ID!
    value: String!
    slug: String!
    description: String
    color: String
    icon: String
    sort_order: Int
    is_default: Boolean!
    is_active: Boolean!
    created_at: DateTime!
    updated_at: DateTime!
}

type Project {
    id: ID!
    value: String
    user_id: ID
    client_id: ID
    status_id: ID
    agent: User @belongsTo(foreignKey: "user_id")
    client: Client @belongsTo(foreignKey: "client_id")
    status: ProjectStatusType @belongsTo(foreignKey: "status_id")
    users: [User!] @belongsToMany(relation: "users")
    "Куратор проекта"
    curator: [User!] @belongsToMany(relation: "curator")
    "Дизайнеры проекта"
    designers: [User!] @belongsToMany(relation: "designers")
    "Менеджеры проекта"
    managers: [User!] @belongsToMany(relation: "managers")
    "Участники проекта с ролями"
    projectUsers: [ProjectUser!] @hasMany(relation: "projectUsers")
    contracts: [Contract!] @hasMany
    "Закупки проекта"
    orders: [Order!] @hasMany
    region: String
    description: String
    is_active: Boolean
    is_incognito: Boolean
    contract_name: String
    contract_number: String
    contract_date: Date
    contract_amount: Float
    agent_percentage: Float
    planned_completion_date: Date
    phones: [ProjectPhone!] @hasMany
    sketches: [ProjectSketch!] @hasMany
    offers: [ProjectOffer!] @hasMany
    "Общий бонус агента по проекту (сумма бонусов из договоров и закупок)"
    totalAgentBonus: Float @field(resolver: "App\\GraphQL\\Resolvers\\ProjectBonusResolver@totalAgentBonus")
    "Общий бонус куратора по проекту (сумма бонусов из договоров и закупок)"
    totalCuratorBonus: Float @field(resolver: "App\\GraphQL\\Resolvers\\ProjectBonusResolver@totalCuratorBonus")
    "Детализация бонусов по проекту"
    bonusDetails: ProjectBonusDetails @field(resolver: "App\\GraphQL\\Resolvers\\ProjectBonusResolver@bonusDetails")
    created_at: DateTime!
    updated_at: DateTime!
}

type ProjectPhone {
    id: ID!
    project_id: ID!
    value: String!
    contact_person: String
    is_primary: Boolean
    created_at: DateTime!
    updated_at: DateTime!
}

input CreateProjectInput {
    value: String!
    user_id: ID
    client_id: ID
    region: String
    description: String
    is_active: Boolean = true
    is_incognito: Boolean = false
    contract_name: String
    contract_date: Date
    contract_amount: Float
    agent_percentage: Float
    planned_completion_date: Date
}

input UpdateProjectInput {
    id: ID!
    value: String
    user_id: ID
    client_id: ID
    status_id: ID
    region: String
    description: String
    is_active: Boolean
    is_incognito: Boolean
    contract_name: String
    contract_date: Date
    contract_amount: Float
    agent_percentage: Float
    planned_completion_date: Date
}

extend type Query {
    "Get all projects"
    projects: [Project!]! @paginate

    "Get a single project by ID"
    project(id: ID! @whereKey): Project @find

    "Get projects by status"
    projectsByStatus(status: ProjectStatus! @where): [Project!]! @paginate

    "Get projects by agent"
    # projectsByAgent(user_id: ID! @where): [Project!]! @paginate
    projectsByAgent(user_id: ID! @where): [Project!]! @all

    "Check if there are any new projects (status_id = 01K7HRKTSQV1894Y3JD9WV5KZX)"
    hasNewProjects: Boolean! @field(resolver: "App\\GraphQL\\Queries\\HasNewProjects")

    "Get all project statuses"
    projectStatuses: [ProjectStatusType!]! @all(model: "App\\Models\\ProjectStatus")

    "Get all clients"
    clients: [Client!]! @all(model: "App\\Models\\Client")

    "Get a single client by ID"
    client(id: ID! @whereKey): Client @find(model: "App\\Models\\Client")
}

type ProjectUser {
    id: ID!
    user_id: ID!
    project_id: ID!
    role: String!
    user: User @belongsTo
    created_at: DateTime!
    updated_at: DateTime!
}

extend type Mutation {
    "Create a new project"
    createProject(input: CreateProjectInput! @spread): Project!

    "Update an existing project"
    updateProject(input: UpdateProjectInput! @spread): Project! @field(resolver: "App\\GraphQL\\Mutations\\UpdateProject")

    "Delete a project"
    deleteProject(id: ID! @whereKey): Project! @delete

    "Accept a project (link user to project with role)"
    acceptProject(projectId: ID!, userId: ID!, statusId: ID, role: String): ProjectUser! @field(resolver: "App\\GraphQL\\Mutations\\AcceptProject")

    "Update a client"
    updateClient(input: UpdateClientInput! @spread): Client! @update(model: "App\\Models\\Client")

    "Update a client with phones"
    updateClientWithPhones(input: UpdateClientWithPhonesInput!): Client! @field(resolver: "App\\GraphQL\\Mutations\\UpdateClientWithPhones")
}

scalar DateTime
    @scalar(class: "Nuwave\\Lighthouse\\Schema\\Types\\Scalars\\DateTime")

scalar Date @scalar(class: "Nuwave\\Lighthouse\\Schema\\Types\\Scalars\\Date")

type Client {
    id: ID!
    name: String!
    birthday: Date
    ban: Boolean!
    status_id: ID
    projects: [Project!] @hasMany
    phones: [ClientPhone!] @hasMany
    created_at: DateTime!
    updated_at: DateTime!
}

type ClientPhone {
    id: ID!
    client_id: ID!
    value: String!
    is_primary: Boolean
    created_at: DateTime!
    updated_at: DateTime!
}

input UpdateClientInput {
    id: ID!
    name: String
    birthday: Date
    ban: Boolean
    status_id: ID
}

input ClientPhoneInput {
    id: ID
    value: String!
    is_primary: Boolean
}

input UpdateClientWithPhonesInput {
    id: ID!
    name: String
    birthday: Date
    ban: Boolean
    status_id: ID
    phones: [ClientPhoneInput!]
}


"Статус договора"
type ContractStatus {
    id: ID!
    value: String!
    slug: String!
    description: String
    color: String
    icon: String
    sort_order: Int!
    is_default: Boolean!
    is_active: Boolean!
}

"Детализация бонусов по проекту"
type ProjectBonusDetails {
    "Список договоров с информацией о бонусах"
    contracts: [ContractBonusInfo!]!
    "Список закупок с информацией о бонусах"
    orders: [OrderBonusInfo!]!
    "Общий бонус агента по проекту"
    totalAgentBonus: Float!
    "Общий бонус куратора по проекту"
    totalCuratorBonus: Float!
    "Сумма бонусов, доступных к выплате"
    totalAvailableBonus: Float!
}

"Информация о бонусах по договору"
type ContractBonusInfo {
    id: ID!
    contract_number: String
    contract_amount: Float
    agent_percentage: Float!
    curator_percentage: Float!
    agent_bonus: Float!
    curator_bonus: Float!
    is_active: Boolean!
    "Доступен ли бонус к выплате"
    is_available: Boolean!
    "Выплачен ли бонус"
    is_paid: Boolean!
}

"Информация о бонусах по закупке"
type OrderBonusInfo {
    id: ID!
    order_number: String!
    order_amount: Float
    agent_percentage: Float!
    curator_percentage: Float!
    agent_bonus: Float!
    curator_bonus: Float!
    is_active: Boolean!
    "Доступен ли бонус к выплате"
    is_available: Boolean!
    "Выплачен ли бонус"
    is_paid: Boolean!
}
