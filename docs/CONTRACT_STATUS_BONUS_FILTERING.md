# Фильтрация бонусов по статусу договора

## Проблема
Бонусы по договорам отображались на странице финансов в сервисе b5-agent даже когда договор находился в статусе "Обработка" (preparing). Это было неправильно, так как бонусы должны начисляться и отображаться только когда статус договора "Заключён" (signed) или далее.

## Решение
Добавлена фильтрация бонусов по статусу договора в GraphQL resolvers и сервисе бонусов.

## Статусы договоров

Согласно миграции `2025_12_13_120001_create_contract_statuses_table.php`:

1. **Обработка** (slug: `preparing`) - статус по умолчанию для новых договоров
2. **Заключён** (slug: `signed`) - договор заключён
3. **Выполнен** (slug: `completed`) - договор успешно выполнен
4. **Рекламация** (slug: `claim`) - по договору подана рекламация
5. **Отказ** (slug: `rejected`) - отказ от договора
6. **Расторгнут** (slug: `terminated`) - договор расторгнут

## Логика отображения бонусов

Бонусы должны отображаться агенту только если:
- Договор в статусе "Заключён" или далее (т.е. НЕ в статусе "Обработка")
- ИЛИ это бонус от заказа (не от договора)

## Изменения

### 1. Файл: `app/GraphQL/Queries/AgentBonusesQuery.php`

Добавлена фильтрация в метод `__invoke`:

```php
$query = AgentBonus::where('agent_id', $user->id)
    ->with(['status', 'contract', 'contract.status', 'order']);

// Фильтруем бонусы: показываем только те, где договор в статусе "Заключён" или далее
$query->where(function ($q) {
    $q->whereHas('contract', function ($contractQuery) {
        $contractQuery->whereHas('status', function ($statusQuery) {
            // Исключаем статус "Обработка" (preparing)
            $statusQuery->where('slug', '!=', 'preparing');
        });
    })
    // Или это бонус от заказа (не от договора)
    ->orWhereNotNull('order_id');
});
```

### 2. Файл: `app/Services/BonusService.php`

Обновлён метод `getAgentStats` с аналогичной фильтрацией:

```php
$query = AgentBonus::where('agent_id', $agentId)
    ->with(['contract.status', 'order']);

// Фильтруем бонусы: показываем только те, где договор в статусе "Заключён" или далее
$query->where(function ($q) {
    $q->whereHas('contract', function ($contractQuery) {
        $contractQuery->whereHas('status', function ($statusQuery) {
            // Исключаем статус "Обработка" (preparing)
            $statusQuery->where('slug', '!=', 'preparing');
        });
    })
    // Или это бонус от заказа (не от договора)
    ->orWhereNotNull('order_id');
});
```

## Результат

Теперь:
1. На странице финансов в b5-agent отображаются только бонусы по договорам в статусе "Заключён" и далее
2. Бонусы по договорам в статусе "Обработка" скрыты от агента
3. Статистика бонусов (total_accrued, total_available, total_paid) также учитывает только видимые бонусы
4. Бонусы от заказов отображаются всегда (независимо от статуса договора)

## Связанные изменения

- В b5-agent также была добавлена фильтрация неактивных заказов в модальном окне просмотра проекта (см. `b5-agent/docs/INACTIVE_ORDERS_FILTER.md`)

## Дата изменения
22 декабря 2024
