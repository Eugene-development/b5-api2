# Сводная таблица: Статусы сущностей и бонусов

## Статусы бонусов

| ID | Code | Название | Описание |
|----|------|----------|----------|
| 1 | `pending` | Ожидание | Бонус ожидает выплаты |
| 3 | `paid` | Погашено | Бонус выплачен агенту |
| 4 | `cancelled` | Аннулирован | Бонус отменён |

---

## ПРОЕКТ (Project)

| Статус | Slug | Влияние на бонусы | Статус бонуса |
|--------|------|-------------------|---------------|
| **Новый проект** | `new-project` | Бонусы наследуют статус от договоров/заказов | `pending` / `available` |
| **Принят куратором** | `curator-processing` | Бонусы наследуют статус от договоров/заказов | `pending` / `available` |
| **Проект закрыт** | `bonus-paid` | Бонусы наследуют статус от договоров/заказов | `pending` / `available` / `paid` |
| **Отказ** | `client-refused` | ❌ **Все бонусы проекта аннулируются** | `cancelled` |

### Логика восстановления для проекта:
- При смене статуса **с** `client-refused` на любой другой — бонусы **восстанавливаются** в `pending`
- После восстановления пересчитывается доступность на основе статусов договоров и заказов

---

## ДОГОВОР (Contract)

| Статус | Slug | Влияние на бонусы | Статус бонуса |
|--------|------|-------------------|---------------|
| **Обработка** | `preparing` | Бонусы НЕ отображаются в статистике (фильтруются) | `pending` (скрыт) |
| **Заключён** | `signed` | Бонус начислен, ожидает выполнения и оплаты | `pending` |
| **Выполнен** | `completed` | Бонус становится доступным если партнёр оплатил | `pending` → `available` (если `partner_paid=true`) |
| **Рекламация** | `claim` | Бонус остаётся в ожидании | `pending` |
| **Отказ** | `rejected` | ❌ **Бонусы аннулируются** | `cancelled` |
| **Расторгнут** | `terminated` | ❌ **Бонусы аннулируются** | `cancelled` |

### Логика восстановления для договора:
- При смене статуса **с** `rejected` или `terminated` на другой — бонусы **восстанавливаются** в `pending`
- После восстановления пересчитывается доступность:
  - Если `status=completed` + `partner_paid=true` → `available`
  - Иначе → `pending`

---

## ЗАКАЗ (Order)

| Статус | Slug | Влияние на бонусы | Статус бонуса |
|--------|------|-------------------|---------------|
| **Сформирован** | `formed` | Бонус начислен, ожидает доставки | `pending` |
| **Доставлен** | `delivered` | Бонус становится доступным к выплате | `available` |
| **Возврат** | `returned` | ❌ **Бонусы аннулируются** | `cancelled` |

### Логика восстановления для заказа:
- При смене статуса **с** `returned` на другой — бонусы **восстанавливаются** в `pending`
- После восстановления:
  - Если `status=delivered` + `is_active=true` → `available`
  - Иначе → `pending`

---

## Дополнительные условия для бонусов

### Флаг `is_active`
- Если `is_active=false` для договора или заказа — бонус остаётся в `pending`
- При `is_active=true` — проверяются остальные условия

### Флаг `paid_at`
- Если `paid_at IS NOT NULL` — бонус **уже выплачен** и его статус **НЕ меняется**
- Все операции аннулирования и восстановления касаются только невыплаченных бонусов

---

## Иерархия приоритетов

```
Проект (статус проекта)
    ↓
    Если Проект = "Отказ" → ВСЕ бонусы проекта аннулируются
    ↓
Договор (статус договора)
    ↓
    Если Договор = "Отказ" или "Расторгнут" → бонусы договора аннулируются
    Если Договор = "Выполнен" + партнёр оплатил → бонусы доступны
    ↓
Заказ (статус заказа)
    ↓
    Если Заказ = "Возврат" → бонусы заказа аннулируются
    Если Заказ = "Доставлен" → бонусы доступны
```

---

## Обновлённые файлы

1. **`BonusService.php`**:
   - `handleContractStatusChange()` — обновлён для восстановления бонусов
   - `handleOrderStatusChange()` — обновлён для восстановления бонусов
   - `restoreAndUpdateContractBonuses()` — новый метод
   - `restoreAndUpdateOrderBonuses()` — новый метод
   - `restoreBonusesForProject()` — новый метод

2. **`UpdateProject.php`**:
   - `handleStatusChange()` — обновлён для восстановления бонусов
   - `restoreProjectBonuses()` — новый метод

---

## Дата обновления: 2026-01-16
