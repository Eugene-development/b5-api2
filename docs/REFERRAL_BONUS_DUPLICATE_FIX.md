# Исправление дублирования бонусов реферальной программы

## Описание проблемы

При создании Заказа или Договора реферала, рефереру начислялись:
- Основной "Личный" бонус (как агенту проекта)
- Реферальный бонус (за сделку реферала)

Это неправильное поведение. По реферальной программе реферер должен получать **только реферальный бонус** за сделки своих рефералов.

## Корневая причина

Проблема возникала, когда:
1. Реферер создавал проект и назначался его владельцем (`projects.user_id` = реферер)
2. При создании договора/заказа в этом проекте:
   - Агентский бонус начислялся владельцу проекта (рефереру) — это "Личный" бонус
   - А затем система искала реферера этого владельца и создавала реферальный бонус

Проблема усугублялась тем, что проверка на создание реферального бонуса не учитывала, является ли реферер одновременно владельцем проекта.

## Внесённые изменения

### 1. `ReferralBonusService.php`

Добавлена **критическая проверка** в методах:
- `createReferralBonusForContract()`
- `createReferralBonusForOrder()`

Теперь перед созданием реферального бонуса проверяется, что **реферер не является владельцем проекта**. Если реферер = владелец проекта, то это **его собственная сделка**, а не сделка реферала, и реферальный бонус не создаётся.

```php
// КРИТИЧЕСКАЯ ПРОВЕРКА: Реферер не должен быть владельцем проекта (агентом)
$projectOwnerId = $this->getProjectOwnerIdFromContract($contract);
if ($projectOwnerId && $referrerId === $projectOwnerId) {
    Log::info('ReferralBonusService: Skipping referral bonus - referrer is project owner', [...]);
    return null;
}
```

### 2. `BonusService.php`

Исправлен fallback в методе `getAgentIdFromProject()`:
- Ранее: при отсутствии `projects.user_id` брался **любой** пользователь из `project_user`
- Теперь: берётся только пользователь с **ролью 'agent'**

```php
// Альтернативно: ищем в связи project_user с ролью 'agent'
// ВАЖНО: фильтруем по роли, чтобы не вернуть куратора или другого пользователя
$projectUser = DB::table('project_user')
    ->where('project_id', $projectId)
    ->where('role', 'agent')  // ← ДОБАВЛЕНО
    ->first();
```

### 3. Новые вспомогательные методы в `ReferralBonusService.php`

Добавлены приватные методы:
- `getProjectOwnerIdFromContract(Contract $contract): ?int`
- `getProjectOwnerIdFromOrder(Order $order): ?int`

Эти методы получают ID владельца проекта из связанного договора или заказа.

## Логика начисления бонусов (правильная)

### Сценарий 1: Реферал создаёт проект и договор

1. Реферал Б создаёт проект → `projects.user_id = Б`
2. Создаётся договор в проекте Б
3. `agentId = Б` (владелец проекта)
4. Агентский бонус → **Б** (реферал получает личный бонус)
5. `referrerId = getReferrerId(Б) = А` (реферер рефераоа Б)
6. Проверка: `referrerId (А) !== projectOwnerId (Б)` ✓
7. Реферальный бонус → **А** (реферер получает реферальный бонус)

### Сценарий 2: Реферер создаёт проект и договор (его собственная сделка)

1. Реферер А создаёт проект → `projects.user_id = А`
2. Создаётся договор в проекте А
3. `agentId = А` (владелец проекта)
4. Агентский бонус → **А** (получает личный бонус)
5. `referrerId = getReferrerId(А)` = реферер А (если есть) или null
6. Проверка: если `referrerId === projectOwnerId (А)` → пропуск!
7. Реферальный бонус → **НЕ создаётся**

### Сценарий 3: Реферер А сам является рефералом пользователя С

1. Реферал Б создаёт проект → `projects.user_id = Б`
2. `agentId = Б`, агентский бонус → **Б**
3. `referrerId = А`, реферальный бонус → **А**
4. При этом у А есть свой реферер С, но бонус за сделку Б идёт только к А

## Рекомендации по очистке данных

Если в базе уже есть дублирующиеся бонусы (личный + реферальный для одного пользователя за одну сделку), рекомендуется:

1. Проверить наличие дубликатов:
```sql
SELECT 
    user_id,
    contract_id,
    COUNT(*) as bonus_count
FROM bonuses
WHERE contract_id IS NOT NULL
GROUP BY user_id, contract_id
HAVING COUNT(*) > 1;
```

2. Для каждого дубликата определить корректный бонус:
   - Если пользователь — владелец проекта → оставить "agent" бонус, удалить "referral"
   - Если пользователь — НЕ владелец проекта → оставить "referral" бонус

## Дата исправления

20 января 2026 г.
